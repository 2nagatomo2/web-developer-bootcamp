# 認証と認可

## 認証: Authentication(=Auth)

ユーザーが誰であるのかを確認するプロセスのこと．
パスワードなどとともに本人であるかどうかを調べる．

### 認証のルール

1. パスワードはそのままデータベースに保存しない
   - パスワードを使い回している場合，一度パスワードが漏れ出てしまうと，他のサービスに影響を及ぼす可能性が高い．
   - ハッシュ関数によってハッシュ化して，データベースに保存する．

#### 暗号学的ハッシュ関数

- 一方向性の関数である(ex: 絶対値など)
  - 入力を当てることはできても，求めることはできない．
- 入力が少しでも違えば，出力が大きく変わる．
- 同じ入力に対して必ず同じ出力となる．
- 異なる入力から同じ出力が生成される確率が極めて低い．
- 関数の実行が意図的に遅い．
  - 高速な hash 関数だと，攻撃側が何度も実行できてしまう．

世の中には，上の条件を満たすようなハッシュ関数があまり多くない．

#### SALT セキュリティの強化

パスワードを使い回す人が多い，同じパスワードを使っている人が世界中にたくさんいる，という事実がある．
データベースの hash 化されたパスワードを得ることができたとき，逆引きの辞書のようなものが作れれば，
多くの人のパスワードを割り出せる可能性がある．

SALT はパスワードの前に任意の文字列をつけることで，hash 化された値を割り出すことを極めて困難にすることができる．

##### 由来

> 塩（salt）は、食品を保存するために使われる防腐剤として長い間使用されてきました。同様に、パスワードのハッシュ化に使用されるランダムな文字列は、ハッシュ値を計算する前にパスワードに追加され、同じパスワードでも異なるハッシュ値を生成するために使用されます。このため、パスワードの安全性を向上させる防御策として、塩（salt）のように使用されることがあり、"Salt"という用語が使用されるようになったとされています。

#### bcrypt

- hash 化のアルゴリズムの一つ
- bcrypt.js と bcrypt という 2 つのライブラリがある．

  - bcrypt.js
    - js で書かれているので，ブラウザ側・サーバー側の両方でで使える．
  - bcrypt(今回はこちらを使う)

    - c++で書かれており，高速に動作する．
    - サーバー側でのみ使えるライブラリ．
    - `npm i bcrypt`でインストール

      ```javascript
      const bcrypt = require("bcript");

      const hashPassword = async (pw) => {
        // const salt = await bcript.getSalt(10);
        // const hash = await bcript.hash(pw, salt);
        const hash = await bcript(pw, 12);
      };

      const login = async (pw hashPW) => {
        const result = await bcript.compare(pw. hashPW);
        if(result) {
          console.log("ログイン成功");
        } else {
          console.log("ログイン失敗");
        }
      }
      ```

    - `getSalt`の第一引数は round
    - round は salt 生成にかかる時間
    - 一般的には 12 が使われる
    - round が増えると，salt 生成にかかる時間は指数関数的に増える
    - `genSalt`を使わずに，hash 関数の第二引数に round を指定することで，一度に salt と hash の生成を行うことができる
    - password の認証には`bcript.compare`に生のパスワードと hash 化されたパスワードを渡して，true が返るかを見れば良い

  - cookie や session と組み合わせることで，ユーザーがログイン済みどうかの情報を保持することができる

## 認可: Authorization(OAuth)

ユーザーが何ができるかを確認するプロセスのこと．
一般的には認証が終わった後に認可を行う．
管理者権限やユーザー権限など．
